<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="Drawer.js"></script><!--class for drawing the tab-->
		<script src="Editor.js"></script><!--class for editing the tab-->
		<script src="Player.js"></script><!--class for playing the tab-->
		<script src="userInput.js"></script><!--contains functions to handle user input-->
		<link rel="stylesheet" href="tab.css" />
	</head>
	<body>
		<!--TODO: make this part cleaner-->
		<p><i>"(!)" indicates a destructive action</i></p>
		<button onclick="clearTrackMeasure()">Clear Track Measure (!)</button>
		<button onclick="addMeasure()">Add Measure</button>
		<button onclick="deleteMeasure()">Delete Measure (!)</button>
		<br /><!--TODO: copy/paste measure buttons-->
		<br /><br />
		<input type="text" placeholder="new tempo" onchange="changeTempo(this.value); this.value=''">
		<br />
		<input type="text" placeholder="new time signature" onchange="changeTimeN(this.value); this.value=''">
		<br />
		<input type="text" placeholder="new time signature" onchange="changeTimeD(this.value); this.value=''">
		<br />
		<button onclick="changeRhythm(1)">1</button>
		<button onclick="changeRhythm(2)">2</button>
		<button onclick="changeRhythm(4)">4</button>
		<button onclick="changeRhythm(8)">8</button>
		<button onclick="changeRhythm(16)">16</button>
		<button onclick="changeRhythm(32)">32</button>
		<button onclick="changeRhythm(64)">64</button>
		<br />
		<!--let this stand as a testament to how disgusting weakly-typed languages are. I just spent about 3 hours trying to track down why it was saying 16<8, and it turns out that "16"<"8". >:( -->
		<!--<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="1">1</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="2">2</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="4">4</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="8">8</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="16">16</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="32">32</input>
		<input type="radio" name="noteDurations" onchange="this.checked=false; changeRhythm(this.value)" value="64">64</input>-->

		<p>Current Track:
			<select id="trackSelector" onchange="changeTrack()">
			</select> <!--loads dynamically below, TODO: way to change the track (name, voice, and strings)-->
		</p>

		<svg id="draw" height="1000">
		</svg>
		<script>
			//hardcoded crazy train, rhythm things, and another one bites the dust, for ease of editing
			hardcodedTab={
				info:{
					title: "crazy train",
					author: "andy roads",
					album: "blizzard of Oz"
				},
				tracks:[
					{
						name: "andy on lead",
						voice: "guitar_distort",
						strings:[
							{
								note: 'E',
								octave: 4
							},
							{
								note: 'B',
								octave: 3
							},
							{
								note: 'G',
								octave: 3
							},
							{
								note: 'D',
								octave: 3
							},
							{
								note: 'A',
								octave: 2
							},
							{
								note: 'E',
								octave: 2
							}
						]
					},
					{
						name: "bass guy",
						voice: "bass_picked",
						strings:[
							{
								note: 'G',
								octave: 2
							},
							{
								note: 'D',
								octave: 2
							},
							{
								note: 'A',
								octave: 1
							},
							{
								note: 'E',
								octave: 1
							}
						]
					}
				],
				measures:[ //measure info, then note info for each of the tracks
					{//measure 2
						timeN: 4,timeD: 4,tempo: 100,
						tracks: [
							[//beats in track 1
								{duration: 1, notes: []},
							],
							[{duration:1,notes:[]}]
						]
					},
				]
			}
		</script>
		<script>
			let tab; //the tab, big ol js object (currently hardcoded above)
			var drawer; //class for working with svg elements
			var editor; //class for handling user input and affecting the "tab" object
			var player; //class for playing the notes back to the user, may be deleted in favor of rendering a .mp3 file on the server for potential performance and parallelism issues

			let inDraw=false; //boolean for if the mouse is in the <svg></svg> area
			let currTrack=0;//start with the first by default

			$(function(){
				let windowWidth=document.body.clientWidth;
				$("#draw").width(windowWidth);
				tab=loadTab();
				window.AudioContext=window.AudioContext || window.webkitAudioContext; //play in Firefox
				drawer=new Drawer(tab,document.getElementById("draw"),windowWidth);
				editor=new Editor(tab,currTrack);
				player=new Player(tab);
				drawer.drawTab(currTrack);
			});

			function loadTab(){
				let loadedTab=hardcodedTab;

				//load dropdown of tracks
				for(let i=0;i<loadedTab.tracks.length;i++){
					let input=document.createElement("option");
					input.setAttribute("value",i);
					input.textContent=loadedTab.tracks[i].name;
					document.getElementById("trackSelector").appendChild(input);
				}

				return loadedTab;
			}

			$("#draw").mouseenter(()=>{inDraw=true});
			$("#draw").mouseleave(()=>{inDraw=false});
			$("body").keydown((event)=>{
				if([32,37,38,39,40].indexOf(event.keyCode)>-1){
						//prevent arrow keys and space from scrolling the page
						event.preventDefault();
					}
				if(inDraw || true){ //don't use the editor if they pressed a key outside the editor
					if(event.keyCode==32){
						if(!player.playing){
							player.play(editor.measure());
						}else{
							player.playing=false; //flag var to false player will notice before playing next measure
						}
					}
					editor.handleKey(event.which);
					drawer.drawTab(currTrack);
					drawer.drawSelector(editor.selected);
				}
			});
		</script>
	</body>
</html>